{"version":3,"file":"analytics-util-session.js","sources":["../src/index.js"],"sourcesContent":["// Session Utilities\nimport { uuid } from 'analytics-utils'\nimport { getSessionItem, setSessionItem } from '@analytics/session-storage-utils'\nimport { setCookie, getCookie, removeCookie } from '@analytics/cookie-utils'\nimport { set, get } from '@analytics/global-storage-utils'\n\nconst PREFIX = '__'\nconst SESSION = 'session'\nconst PAGE = 'page'\nconst KEYS = ['id', 'createdAt', 'created']\nconst TIMEOUT = 30\n\nfunction getDate(x) {\n  const d = (x) ? new Date(x) : new Date()\n  return [ d.toISOString(), d.getTime() ]\n}\n\nexport function sessionData() {\n  const [ iso, unix ] = getDate()\n  return {\n    id: uuid(),\n    created: unix,\n    createdAt: iso,\n  }\n}\n\nfunction logic(kind, isSetter) {\n  const storageMechanism = {\n    session: [ getSessionItem, setSessionItem ],\n    page: [ get, set ]\n  }\n  const [ getter, setter ] = storageMechanism[kind]\n  const data = sessionData()\n  let isNew = false\n  let info = {}\n\n  for (let i = 0; i < KEYS.length; i++) {\n    const key = KEYS[i]\n    // e.g. __page__session__createdAt\n    const k = PREFIX + kind + PREFIX + SESSION + PREFIX + key\n    const currentVal = getter(k)\n    // Triple ! sets !!!false | !!!null | !!!undefined to true\n    isNew = isSetter || !!!currentVal\n    const value = (currentVal && !isSetter) ? currentVal : setter(k, data[key])\n    const finValue = (key !== 'created') ? value : Number(value)\n    info[key] = finValue\n  }\n\n  return addContext(info, isNew)\n}\n\nfunction addContext(obj, isNew) {\n  const now = Date.now()\n  obj.elapsed = now - obj.created\n  if (obj.expires) obj.remaining = Math.abs(obj.expires - now)\n  obj.isNew = isNew\n  return obj\n}\n\nfunction getName() {\n  return PREFIX + SESSION\n}\n\nexport function getSession(minutes = TIMEOUT, persistedOnly)  {\n  const cookieData = getCookie(getName())\n  const data = (cookieData) ? JSON.parse(cookieData) : setSession(minutes)\n  return persistedOnly ? data : addContext(data, !!!cookieData)\n}\n\nexport function setSession(minutes = TIMEOUT, extra, extend) {\n  // const { extend, minutes } = opts\n  let data = extend ? getSession(minutes, true) : sessionData()\n  const exp = 60 * minutes\n  let timeExpire = data.created\n  if (extend) {\n    const [ iso, unix ] = getDate()\n    data.modified = unix\n    data.modifiedAt = iso\n    timeExpire = unix\n  }\n  const [ expiresIso, expiresUnix ] = getDate(timeExpire + (exp * 1e3))\n  data.expires = expiresUnix\n  data.expiresAt = expiresIso\n  if (extra) {\n    data = Object.assign(data, extra)\n  }\n  setCookie(getName(), JSON.stringify(data), exp)\n  return addContext(data, !extend)\n}\n\nexport const extendSession = (minutes = TIMEOUT, extra) => setSession((minutes || 1), extra, true)\n\nexport const removeSession = () => removeCookie(getName())\n\nexport const getTabSession = logic.bind(null, SESSION)\nexport const setTabSession = logic.bind(null, SESSION, true)\n\nexport const getPageSession = logic.bind(null, PAGE)\nexport const setPageSession = logic.bind(null, PAGE, true)"],"names":["KEYS","getDate","x","d","Date","toISOString","getTime","sessionData","iso","unix","id","uuid","created","createdAt","logic","kind","isSetter","session","getSessionItem","setSessionItem","page","get","set","getter","setter","data","isNew","info","i","length","key","k","PREFIX","currentVal","value","finValue","Number","addContext","obj","now","elapsed","expires","remaining","Math","abs","getSession","minutes","persistedOnly","cookieData","getCookie","JSON","parse","setSession","extra","extend","exp","timeExpire","modified","modifiedAt","expiresIso","expiresAt","Object","assign","setCookie","stringify","extendSession","getTabSession","bind","setTabSession","getPageSession","setPageSession","removeCookie"],"mappings":"iKASMA,EAAO,CAAC,KAAM,YAAa,WAGjC,SAASC,EAAQC,GACf,IAAMC,EAAKD,EAAK,IAAIE,KAAKF,GAAK,IAAIE,KAClC,MAAO,CAAED,EAAEE,cAAeF,EAAEG,oBAGdC,IACd,MAAsBN,IAAdO,OAAKC,OACb,MAAO,CACLC,GAAIC,SACJC,QAASH,EACTI,UAAWL,GAIf,SAASM,EAAMC,EAAMC,GAUnB,IATA,MAAyB,CACvBC,QAAS,CAAEC,iBAAgBC,kBAC3BC,KAAM,CAAEC,MAAKC,QAE6BP,GAApCQ,OAAQC,OACVC,EAAOlB,IACTmB,GAAQ,EACRC,EAAO,GAEFC,EAAI,EAAGA,EAAI5B,EAAK6B,OAAQD,IAAK,CACpC,IAAME,EAAM9B,EAAK4B,GAEXG,EAjCK,KAiCQhB,EAATiB,cAA4CF,EAChDG,EAAaV,EAAOQ,GAE1BL,EAAQV,IAAeiB,EACvB,IAAMC,EAASD,IAAejB,EAAYiB,EAAaT,EAAOO,EAAGN,EAAKK,IAChEK,EAAoB,YAARL,EAAqBI,EAAQE,OAAOF,GACtDP,EAAKG,GAAOK,EAGd,OAAOE,EAAWV,EAAMD,GAG1B,SAASW,EAAWC,EAAKZ,GACvB,IAAMa,EAAMnC,KAAKmC,MAIjB,OAHAD,EAAIE,QAAUD,EAAMD,EAAI1B,QACpB0B,EAAIG,UAASH,EAAII,UAAYC,KAAKC,IAAIN,EAAIG,QAAUF,IACxDD,EAAIZ,MAAQA,EACLY,WAOOO,EAAWC,EAAmBC,YAAnBD,IAAAA,EArDX,IAsDd,IAAME,EAAaC,YAJZjB,aAKDP,EAAQuB,EAAcE,KAAKC,MAAMH,GAAcI,EAAWN,GAChE,OAAOC,EAAgBtB,EAAOY,EAAWZ,GAASuB,YAGpCI,EAAWN,EAAmBO,EAAOC,YAA1BR,IAAAA,EA3DX,IA6Dd,IAAIrB,EAAO6B,EAAST,EAAWC,GAAS,GAAQvC,IAC1CgD,EAAM,GAAKT,EACbU,EAAa/B,EAAKb,QACtB,GAAI0C,EAAQ,CACV,MAAsBrD,IAAdO,OAAKC,OACbgB,EAAKgC,SAAWhD,EAChBgB,EAAKiC,WAAalD,EAClBgD,EAAa/C,EAEf,MAAoCR,EAAQuD,EAAoB,IAAND,GAAlDI,OAOR,OANAlC,EAAKgB,aACLhB,EAAKmC,UAAYD,EACbN,IACF5B,EAAOoC,OAAOC,OAAOrC,EAAM4B,IAE7BU,YA1BO/B,YA0BckB,KAAKc,UAAUvC,GAAO8B,GACpClB,EAAWZ,GAAO6B,GAGdW,IAIAC,EAAgBpD,EAAMqD,KAAK,KAvFxB,WAwFHC,EAAgBtD,EAAMqD,KAAK,KAxFxB,WAwFuC,GAE1CE,EAAiBvD,EAAMqD,KAAK,KAzF5B,QA0FAG,EAAiBxD,EAAMqD,KAAK,KA1F5B,QA0FwC,yBARxB,SAACrB,EAAmBO,mBAAnBP,IAAAA,EAhFd,IAgF2CM,EAAYN,GAAW,EAAIO,GAAO,gGAEhE,kBAAMkB,eAhC1BvC"}